<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‚Äì ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</title>

  <link rel="stylesheet" href="assets/css/base.css">
  <link rel="stylesheet" href="assets/css/employee.css">

  <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á -->
  <style>
    .center-alert-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .center-alert-box{
      background:#ffffff;
      border-radius:18px;
      padding:24px 28px;
      max-width:360px;
      width:90%;
      box-shadow:0 20px 40px rgba(15,23,42,.25);
      text-align:center;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    .center-alert-title{
      font-size:18px;
      font-weight:700;
      margin-bottom:6px;
      color:#0f172a;
    }
    .center-alert-message{
      font-size:14px;
      color:#4b5563;
      margin-bottom:16px;
      white-space:pre-line;
    }
    .center-alert-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:8px 22px;
      border-radius:999px;
      border:none;
      background:#0ea5e9;
      color:#ffffff;
      font-weight:600;
      font-size:14px;
      cursor:pointer;
    }
    .center-alert-btn:focus{
      outline:2px solid #bae6fd;
      outline-offset:2px;
    }

    /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö */
    .form-error {
      color: #dc2626;
      font-size: 13px;
      margin-top: 4px;
      display: none;
      font-weight: 500;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    input.error, textarea.error {
      border-color: #dc2626 !important;
      background-color: #fef2f2;
    }

    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ */
    .account-limit-info {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      padding: 8px 12px;
      border-radius: 8px;
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      font-size: 13px;
    }
    .account-limit-info .limit-badge {
      background: #d90902;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    /* ===== ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢ ===== */
    .mail-btn{
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:42px;
      height:42px;
      border-radius:999px;
      border:1px solid rgba(125,211,252,0.9);
      background: rgba(240,249,255,0.95);
      cursor:pointer;
      box-shadow:0 10px 22px rgba(15,23,42,.12);
      text-decoration:none;
      color:#0f172a;
      font-weight:900;
    }
    .mail-badge{
      position:absolute;
      top:-6px;
      right:-6px;
      min-width:22px;
      height:22px;
      padding:0 6px;
      border-radius:999px;
      background:#ef4444;
      color:#fff;
      display:none;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:900;
      box-shadow:0 10px 20px rgba(239,68,68,.35);
    }

    .inbox-modal .modal-box{ max-width:720px; }
    .inbox-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .inbox-empty{
      text-align:center;
      color:#64748b;
      padding:24px 0;
      font-weight:700;
    }
    .inbox-toolbar{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:6px;
    }
  </style>

  <script>
    window.BACKEND_URL = "http://localhost/school_api/public";
  </script>
</head>
<body>
<header>
  <div class="wrap row" style="justify-content:space-between">
    <div>
      <h1>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
      <div class="subtitle">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£)</div>
    </div>

    <div class="nav" id="navUser" style="gap:10px;">
      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢ -->
      <a class="mail-btn" href="#" id="inboxBtn" title="‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢">
        ‚úâ
        <span class="mail-badge" id="inboxBadge">0</span>
      </a>

      <span class="status" id="who"></span>
      <a class="btn" href="#" id="logout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
    </div>
  </div>
</header>

<main class="wrap emp-layout" id="empLayout">
  <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π -->
  <button class="sidebar-toggle" id="sidebarToggle">‚ò∞ ‡πÄ‡∏°‡∏ô‡∏π</button>

  <!-- ‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á -->
  <aside class="emp-sidebar" id="empSidebar">
    <div class="emp-sidebar-header">
      <div class="emp-sidebar-title">‡πÄ‡∏°‡∏ô‡∏π‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
      <div class="emp-sidebar-sub">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</div>
    </div>
    <nav class="emp-nav">
      <button class="emp-nav-item is-active" data-view="requests">
        üìÑ ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
      </button>
      <button class="emp-nav-item" data-view="finance">
        üí∞ ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô
      </button>
      <button class="emp-nav-item" data-view="credit">
        ‚≠ê ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï
      </button>
    </nav>
  </aside>

  <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å -->
  <section class="emp-main">
    <!-- View 1 -->
    <section id="view-requests" class="emp-view is-active">
      <div class="card">
        <!-- ‡πÅ‡∏ñ‡∏ö‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô -->
        <div style="
          display:flex;
          flex-wrap:wrap;
          gap:8px;
          align-items:center;
          margin-bottom:12px;
          padding:10px 12px;
          border-radius:10px;
          background:#eff6ff;
          border:1px solid #bfdbfe;
        ">
          <span style="font-weight:600;">‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</span>
          <span id="req-credit-balance" style="font-size:18px;font-weight:800;color:#1d4ed8;">-</span>
          <span style="font-weight:500;">‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</span>
          <span style="margin-left:auto;color:#64748b;font-size:13px;font-weight:700;">
            ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ï‡πà‡∏≠‡∏Ñ‡∏≥‡∏Ç‡∏≠: <b>5</b> ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï
          </span>
        </div>

        <div class="grid g2">
          <div>
            <label>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
            <input id="title" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô" />
            <div id="title-error" class="form-error">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
          </div>
          <div>
            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
            <input id="amount" type="number" min="0" step="1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1000" />
            <div id="amount-error" class="form-error">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
          <textarea id="desc" placeholder="‡πÅ‡∏ô‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö"></textarea>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="btnSubmit" class="ok">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        </div>
      </div>

      <div class="card">
        <h3>‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
        <table id="myTable" style="margin-top:8px">
          <thead>
            <tr>
              <th>‡∏£‡∏´‡∏±‡∏™</th>
              <th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
              <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î / ‡∏¢‡∏∑‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- View 2 -->
    <section id="view-finance" class="emp-view">
      <div class="card">
        <h3>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h3>
        <p class="emp-note">‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
        <div id="fin-balance" style="font-size:24px;font-weight:800;color:#0369a1;">
          - (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...)
        </div>
      </div>

      <div class="card">
        <h3>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>

        <div class="account-limit-info">
          <span class="limit-badge">‡∏à‡∏≥‡∏Å‡∏±‡∏î</span>
          <span>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 2 ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>
        </div>

        <p class="emp-note">
          ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        </p>
        <table style="margin-top:8px">
          <thead>
            <tr>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
              <th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th>
              <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
              <th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
            </tr>
          </thead>
          <tbody id="fin-accounts-body">
            <tr><td colspan="4">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ -</td></tr>
          </tbody>
        </table>

        <hr style="margin:16px 0;border:none;border-top:1px solid #e5e7eb;">
        <h4 style="margin-top:0;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h4>
        <form id="fin-account-form" class="grid g2" style="margin-top:8px;gap:12px;">
          <div>
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
            <input id="fin-account-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á" />
          </div>
          <div>
            <label>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
            <input id="fin-bank-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢, ‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢" />
          </div>
          <div>
            <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
            <input id="fin-account-number" placeholder="‡πÄ‡∏ä‡πà‡∏ô 123-4-56789-0" />
          </div>
          <div class="row" style="align-items:flex-end;gap:8px;">
            <button type="submit" id="fin-add-account-btn" class="ok">
              + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
            </button>
          </div>
        </form>
      </div>

      <div class="card">
        <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</h2>
        <p class="emp-note">‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</p>
        <table style="margin-top:8px">
          <thead>
            <tr>
              <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
              <th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ / ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
              <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
            </tr>
          </thead>
          <tbody id="fin-transfers-body">
            <tr><td colspan="4">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô -</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- View 3 -->
    <section id="view-credit" class="emp-view">
      <div class="card">
        <h3>‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
        <p class="emp-note">‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</p>

        <div style="margin:12px 0;padding:12px 16px;border-radius:12px;background:#eff6ff;border:1px solid #bfdbfe;display:flex;align-items:center;gap:8px;">
          <span style="font-weight:600;">‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span>
          <span id="credit-balance" style="font-size:22px;font-weight:800;color:#1d4ed8;">-</span>
          <span style="font-weight:500;">‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</span>
        </div>

        <div style="margin-top:12px;">
          <label for="credit-topup-amount">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</label>
          <div class="row" style="gap:8px;margin-top:4px;align-items:center;">
            <input type="number" id="credit-topup-amount" min="1" step="1" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°" />
            <button type="button" id="credit-topup-btn" class="ok">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</button>
          </div>
          <p id="credit-message" class="emp-note" style="margin-top:8px;"></p>
        </div>
      </div>
    </section>
  </section>
</main>

<!-- Modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î + Timeline -->
<div id="detailModal" class="modal-backdrop">
  <div class="modal-box">
    <div class="modal-header">
      <h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠</h3>
      <button class="modal-close" id="detailClose">&times;</button>
    </div>
    <div class="modal-body">
      <div class="detail-section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠</div>
      <div class="detail-grid">
        <div class="detail-label">‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≥‡∏Ç‡∏≠</div>
        <div class="detail-value" id="d-id">-</div>

        <div class="detail-label">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
        <div class="detail-value" id="d-school">-</div>

        <div class="detail-label">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</div>
        <div class="detail-value" id="d-title">-</div>

        <div class="detail-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>
        <div class="detail-value" id="d-amount">-</div>

        <div class="detail-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
        <div class="detail-value">
          <span class="tag-status" id="d-status">-</span>
        </div>

        <div class="detail-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
        <div class="detail-value" id="d-desc">-</div>
      </div>

      <div class="detail-section-title">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Timeline)</div>
      <table class="timeline-table">
        <thead>
          <tr>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th>
            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
            <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
          </tr>
        </thead>
        <tbody id="d-timeline-body"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏Ç‡∏≠/‡∏¢‡∏∑‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á -->
<div id="editModal" class="modal-backdrop">
  <div class="modal-box edit-modal-box">
    <div class="modal-header">
      <h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏Ç‡∏≠ &amp; ‡∏¢‡∏∑‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</h3>
      <button class="modal-close" id="editClose">&times;</button>
    </div>
    <div class="modal-body">
      <div class="detail-section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠</div>
      <div class="detail-grid">
        <div class="detail-label">‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≥‡∏Ç‡∏≠</div>
        <div class="detail-value" id="e-id">-</div>

        <div class="detail-label">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</div>
        <div class="detail-value">
          <input id="e-title" />
        </div>

        <div class="detail-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</div>
        <div class="detail-value">
          <input id="e-amount" type="number" min="0" step="1" />
        </div>

        <div class="detail-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
        <div class="detail-value">
          <textarea id="e-desc" rows="4"></textarea>
        </div>

        <div class="detail-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡πà‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
        <div class="detail-value">
          <input id="e-note" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß" />
        </div>
      </div>

      <div class="row" style="margin-top:12px; justify-content:flex-end; gap:8px;">
        <button type="button" class="ghost" id="editCancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button type="button" class="ok" id="editSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å &amp; ‡∏¢‡∏∑‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ Modal ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢ -->
<div id="inboxModal" class="modal-backdrop inbox-modal">
  <div class="modal-box">
    <div class="modal-header">
      <h3>‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢</h3>
      <button class="modal-close" id="inboxClose">&times;</button>
    </div>
    <div class="modal-body">
      <div class="inbox-toolbar">
        <button type="button" class="btn-link" id="inboxReadAllBtn">‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <button type="button" class="btn-link" id="inboxRefreshBtn">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
      </div>

      <div id="inboxEmpty" class="inbox-empty">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
      <div id="inboxList" class="inbox-list"></div>
    </div>
  </div>
</div>

<!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á -->
<div id="centerAlert" class="center-alert-backdrop">
  <div class="center-alert-box">
    <div class="center-alert-title" id="centerAlertTitle">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
    <div class="center-alert-message" id="centerAlertMessage">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
    <button id="centerAlertOk" class="center-alert-btn">‡∏ï‡∏Å‡∏•‡∏á</button>
  </div>
</div>

<script src="assets/js/common.js"></script>
<script>
  const BASE  = window.BACKEND_URL || "http://localhost/school_api/public";
  const token = localStorage.getItem("jwt_token");
  if (!token) location.href = "index.html";

  // ==== STATUS CODES ====
  const STATUS_PENDING  = "Pending";
  const STATUS_APPROVED = "Approved";
  const STATUS_REJECTED = "Rejected";
  const STATUS_REVIEWED = "Reviewed";

  // ‚úÖ ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ï‡πà‡∏≠‡∏Ñ‡∏≥‡∏Ç‡∏≠/‡πÇ‡∏≠‡∏ô
  const FEE_PER_TRANSFER = 5;

  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
  const MAX_BANK_ACCOUNTS = 2;

  function roleLabel(role){
    switch(role){
      case 'employee':      return '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
      case 'director':      return '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£';
      case 'icorp-staff':   return '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ICORP';
      case 'icorp-manager': return '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ ICORP';
      default:              return role || '-';
    }
  }

  function mapStatusLabel(s){
    switch(s){
      case STATUS_PENDING:  return "Pending";
      case STATUS_APPROVED: return "Approved";
      case STATUS_REJECTED: return "Rejected";
      case STATUS_REVIEWED: return "Reviewed";
      default:              return s || "-";
    }
  }

  function mapStatusClass(s){
    switch(s){
      case STATUS_PENDING:  return "status-pending";
      case STATUS_APPROVED: return "status-approved";
      case STATUS_REJECTED: return "status-rejected";
      case STATUS_REVIEWED: return "status-reviewed";
      default:              return "";
    }
  }

  function fmtBaht(n){
    try { return Number(n).toLocaleString('th-TH',{minimumFractionDigits:0}); }
    catch { return n; }
  }
  function fmtDateTime(str){
    if(!str) return '-';
    try{
      const d = new Date(str);
      return d.toLocaleString('th-TH');
    }catch(e){ return str; }
  }
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function verifyMe(){
    const url = `${BASE}/api/auth/me?token=${encodeURIComponent(token)}`;
    const res = await fetch(url, { headers:{Authorization:"Bearer "+token} });
    const data = await res.json().catch(()=>({}));
    if(!res.ok || !data.profile) throw new Error("verify-failed");
    return data.profile;
  }

  function bindLogout(){
    const lg = document.getElementById("logout");
    if(!lg) return;
    lg.addEventListener("click", e=>{
      e.preventDefault();
      localStorage.removeItem("jwt_token");
      localStorage.removeItem("icr_session_v1");
      location.href = "index.html";
    });
  }

  // ===== ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á =====
  function showCenterAlert(options = {}){
    const title   = options.title   || "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô";
    const message = options.message || "";
    const onClose = typeof options.onClose === "function" ? options.onClose : null;

    const wrap   = document.getElementById("centerAlert");
    const tEl    = document.getElementById("centerAlertTitle");
    const mEl    = document.getElementById("centerAlertMessage");
    const okBtn  = document.getElementById("centerAlertOk");

    if(!wrap || !tEl || !mEl || !okBtn){
      alert(message || title);
      if(onClose) onClose();
      return;
    }

    tEl.textContent = title;
    mEl.textContent = message;

    wrap.style.display = "flex";

    const closeHandler = () => {
      wrap.style.display = "none";
      okBtn.removeEventListener("click", closeHandler);
      wrap.removeEventListener("click", backdropHandler);
      if(onClose) onClose();
    };

    const backdropHandler = (e) => {
      if(e.target === wrap) closeHandler();
    };

    okBtn.addEventListener("click", closeHandler);
    wrap.addEventListener("click", backdropHandler);
  }

  // ===== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° =====
  function initFormValidation() {
    const titleInput = document.getElementById('title');
    const amountInput = document.getElementById('amount');

    function hideError(inputId) {
      const errorEl = document.getElementById(inputId + '-error');
      if (errorEl) errorEl.style.display = 'none';
      const inputEl = document.getElementById(inputId);
      if (inputEl) inputEl.classList.remove('error');
    }

    titleInput.addEventListener('input', function() {
      if (this.value.trim()) hideError('title');
    });

    amountInput.addEventListener('input', function() {
      const amount = parseFloat(this.value);
      if (amount && amount > 0) hideError('amount');
    });
  }

  let allRequests = [];
  let editingRequest = null;
  let currentAccounts = [];

  // ====== NOTIFICATIONS (‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢) ======
  let unreadNotifs = [];

  function updateInboxBadge(count){
    const badge = document.getElementById("inboxBadge");
    if(!badge) return;
    if(count > 0){
      badge.style.display = "inline-flex";
      badge.textContent = String(count);
    }else{
      badge.style.display = "none";
      badge.textContent = "0";
    }
  }

  async function loadUnreadNotifications(){
    try{
      const res = await fetch(`${BASE}/api/notifications`, {
        headers:{ Authorization:"Bearer "+token }
      });
      const data = await res.json().catch(()=> ({}));
      if(!res.ok) return { items: [], error: (data && data.error) ? data.error : `HTTP ${res.status}` };
      if(!data.ok) return { items: [], error: data.error || "API ok=false" };
      return { items: Array.isArray(data.items) ? data.items : [], error: null };
    }catch(e){
      return { items: [], error: e.message || "network error" };
    }
  }

  async function markNotificationRead(id){
    try{
      await fetch(`${BASE}/api/notifications/${encodeURIComponent(id)}/read`, {
        method:"POST",
        headers:{ Authorization:"Bearer "+token }
      });
    }catch(e){}
  }

  async function markAllNotificationsRead(){
    try{
      await fetch(`${BASE}/api/notifications/read-all`, {
        method:"POST",
        headers:{ Authorization:"Bearer "+token }
      });
    }catch(e){}
  }

  function renderInbox(extraErrorText = null){
    const listEl  = document.getElementById("inboxList");
    const emptyEl = document.getElementById("inboxEmpty");
    if(!listEl || !emptyEl) return;

    if(extraErrorText){
      emptyEl.style.display = "block";
      emptyEl.textContent = "‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + extraErrorText;
      listEl.innerHTML = "";
      return;
    }

    if(!unreadNotifs.length){
      emptyEl.style.display = "block";
      emptyEl.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô";
      listEl.innerHTML = "";
      return;
    }

    emptyEl.style.display = "none";
    listEl.innerHTML = unreadNotifs.map(n => `
      <div style="border:1px solid #e5e7eb;border-radius:14px;padding:12px 14px;background:#ffffff;box-shadow:0 10px 20px rgba(15,23,42,.06);">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;">
          <div>
            <div style="font-weight:900;color:#0f172a;font-size:15px;">
              ${escapeHtml(n.title || "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô")}
            </div>
            <div style="color:#64748b;font-size:12px;margin-top:2px;">
              ${n.request_id ? `‡∏Ñ‡∏≥‡∏Ç‡∏≠: <b>${escapeHtml(n.request_id)}</b> ‚Ä¢ ` : ""}${fmtDateTime(n.created_at)}
            </div>
          </div>
          <button class="btn-link" type="button" data-open-notif="${escapeHtml(n.id)}">‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡πà‡∏≤‡∏ô</button>
        </div>
      </div>
    `).join("");

    listEl.querySelectorAll("button[data-open-notif]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-open-notif");
        const notif = unreadNotifs.find(x => String(x.id) === String(id));
        if(!notif) return;

        showCenterAlert({
          title: notif.title || "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô",
          message: notif.message || "-",
          onClose: async () => {
            await markNotificationRead(id);
            await refreshInbox();
          }
        });
      });
    });
  }

  async function refreshInbox(){
    const result = await loadUnreadNotifications();
    unreadNotifs = result.items || [];
    updateInboxBadge(unreadNotifs.length);
    renderInbox(result.error);
  }

  function wireInbox(){
    const btn   = document.getElementById("inboxBtn");
    const modal = document.getElementById("inboxModal");
    const close = document.getElementById("inboxClose");
    const readAllBtn = document.getElementById("inboxReadAllBtn");
    const refreshBtn = document.getElementById("inboxRefreshBtn");

    function showInbox(){ modal.classList.add("show"); }
    function hideInbox(){ modal.classList.remove("show"); }

    btn.addEventListener("click", async (e)=>{
      e.preventDefault();
      showInbox();
      await refreshInbox();
    });

    close.addEventListener("click", hideInbox);
    modal.addEventListener("click", (e)=>{ if(e.target === modal) hideInbox(); });

    refreshBtn.addEventListener("click", async ()=>{ await refreshInbox(); });

    readAllBtn.addEventListener("click", async ()=>{
      await markAllNotificationsRead();
      await refreshInbox();
      showCenterAlert({ title:"‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", message:"‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß" });
    });
  }

  async function loadMyRequests(){
    const r = await fetch(`${BASE}/api/requests`, {
      headers:{Authorization:"Bearer "+token}
    });
    if(r.status === 401){
      localStorage.removeItem("jwt_token");
      localStorage.removeItem("icr_session_v1");
      location.href = "index.html";
      return;
    }
    const j = await r.json();
    const items = Array.isArray(j.items) ? j.items : [];
    allRequests = items;

    const tb = document.querySelector("#myTable tbody");
    tb.innerHTML = items.map(row => `
      <tr>
        <td class="mono">${row.id}</td>
        <td>${row.title ?? '-'}</td>
        <td>${fmtBaht(Number(row.amount || 0))}</td>
        <td>
          <span class="status ${mapStatusClass(row.status)}">
            ${mapStatusLabel(row.status)}
          </span>
        </td>
        <td>
          <div class="action-buttons">
            <button class="btn-link" data-detail-id="${row.id}">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
            ${row.status === STATUS_REJECTED
              ? `<button class="btn-retry" data-retry-id="${row.id}">‡∏¢‡∏∑‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>`
              : ""}
          </div>
        </td>
      </tr>
    `).join("");

    tb.querySelectorAll("button[data-detail-id]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-detail-id");
        openDetailModal(id);
      });
    });

    tb.querySelectorAll("button[data-retry-id]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-retry-id");
        const req = allRequests.find(r => String(r.id) === String(id));
        if (!req) {
          showCenterAlert({ title: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", message: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠" });
          return;
        }
        openEditModal(req);
      });
    });
  }

  // ===== ‡∏î‡∏∂‡∏á‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ "‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å" =====
  async function loadCreditSummaryForRequest(){
    const balEl = document.getElementById("req-credit-balance");
    if(!balEl) return;
    balEl.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
    delete balEl.dataset.raw;

    try{
      const res = await fetch(`${BASE}/api/finance/credits`, {
        headers:{ Authorization:"Bearer "+token }
      });
      const data = await res.json().catch(()=>({}));
      if(!res.ok || !data.ok){
        throw new Error(data.error || "‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      }
      const bal = Number(data.balance ?? 0);
      balEl.textContent = fmtBaht(bal);
      balEl.dataset.raw = String(bal);
    }catch(e){
      balEl.textContent = "-";
    }
  }

  function wireForm(){
    const btn = document.getElementById("btnSubmit");
    btn.addEventListener("click", async ()=>{
      const title  = document.getElementById("title").value.trim();
      const amount = Number(document.getElementById("amount").value);
      const desc   = document.getElementById("desc").value.trim();

      let isValid = true;
      if (!title) {
        document.getElementById('title-error').style.display = 'block';
        document.getElementById('title').classList.add('error');
        isValid = false;
      }
      if (!amount || amount <= 0) {
        document.getElementById('amount-error').style.display = 'block';
        document.getElementById('amount').classList.add('error');
        isValid = false;
      }
      if (!isValid) return;

      btn.disabled = true;

      // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÅ‡∏ö‡∏ö amount + fee (5)
      try{
        const resCredit = await fetch(`${BASE}/api/finance/credits`, {
          headers:{ Authorization:"Bearer "+token }
        });
        const creditData = await resCredit.json().catch(()=>({}));
        if(resCredit.ok && creditData.ok){
          const bal = Number(creditData.balance ?? 0);
          const smallEl = document.getElementById("req-credit-balance");
          if(smallEl){
            smallEl.textContent = fmtBaht(bal);
            smallEl.dataset.raw = String(bal);
          }

          const fee = FEE_PER_TRANSFER;
          const totalNeed = amount + fee;

          // ‚úÖ ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏û‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£: ‡∏°‡∏µ 5000 ‡∏Ç‡∏≠ 5000 -> ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ú‡∏∑‡πà‡∏≠ 5)
          if(bal < totalNeed){
            showCenterAlert({
              title:"‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠",
              message:
                "‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° 5)\n" +
                "‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: " + fmtBaht(bal) + " ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï\n" +
                "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠: " + fmtBaht(amount) + " ‡∏ö‡∏≤‡∏ó\n" +
                "‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°: " + fmtBaht(fee) + " ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï\n" +
                "‡∏£‡∏ß‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ: " + fmtBaht(totalNeed) + " ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï"
            });
            btn.disabled = false;
            return;
          }
        }
      }catch(e){
        // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ backend ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô
      }

      // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠
      try{
        const res = await fetch(`${BASE}/api/requests`, {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            Authorization:"Bearer "+token
          },
          body:JSON.stringify({
            school:"‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á",
            title,
            amount,
            desc
          })
        });
        const data = await res.json().catch(()=>({}));

        if(!res.ok || !data.ok){
          // ‚úÖ ‡∏ñ‡πâ‡∏≤ backend ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î credit/fee/total ‡∏°‡∏≤ ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏Ñ‡∏£‡∏ö
          if(data && data.credit !== undefined && data.fee !== undefined && data.total !== undefined){
            showCenterAlert({
              title:"‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
              message:
                (data.error || "‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÑ‡∏°‡πà‡∏û‡∏≠") + "\n" +
                "‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: " + fmtBaht(data.credit) + "\n" +
                "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠: " + fmtBaht(data.amount) + "\n" +
                "‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°: " + fmtBaht(data.fee) + "\n" +
                "‡∏£‡∏ß‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ: " + fmtBaht(data.total)
            });
            throw new Error("stop");
          }
          throw new Error(data.error || "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }

        document.getElementById("title").value   = "";
        document.getElementById("amount").value  = "";
        document.getElementById("desc").value    = "";

        await loadMyRequests();
        await loadCreditSummaryForRequest();

        showCenterAlert({ title:"‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", message:"‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!" });
      }catch(err){
        if(String(err.message) !== "stop"){
          showCenterAlert({
            title:"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î",
            message:"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message
          });
        }
      }finally{
        btn.disabled = false;
      }
    });
  }

  // ===== Modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î =====
  const modal   = document.getElementById("detailModal");
  const closeBtn= document.getElementById("detailClose");
  function showModal(){ modal.classList.add("show"); }
  function hideModal(){ modal.classList.remove("show"); }

  closeBtn.addEventListener("click", hideModal);
  modal.addEventListener("click", e=>{ if(e.target===modal) hideModal(); });

  async function openDetailModal(id){
    try{
      const res = await fetch(`${BASE}/api/requests/${encodeURIComponent(id)}/timeline`, {
        headers:{ Authorization:"Bearer "+token }
      });
      const data = await res.json().catch(()=>({}));
      if(!res.ok) throw new Error(data.error || "‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

      const r  = data.request || {};
      const tl = Array.isArray(data.timeline) ? data.timeline : [];

      document.getElementById("d-id").textContent     = r.id || "-";
      document.getElementById("d-school").textContent = r.school || "-";
      document.getElementById("d-title").textContent  = r.title || "-";
      document.getElementById("d-amount").textContent =
        r.amount ? fmtBaht(r.amount) + " ‡∏ö‡∏≤‡∏ó" : "-";
      document.getElementById("d-status").textContent =
        mapStatusLabel(r.status);
      document.getElementById("d-desc").textContent   =
        r.description || "-";

      const tb = document.getElementById("d-timeline-body");

      const sortedTimeline = [...tl].sort(
        (a, b) => new Date(b.created_at) - new Date(a.created_at)
      );

      tb.innerHTML = sortedTimeline.map((row, idx) => {
        const isLatest = idx === 0;
        const statusClass = row.action ? `status-${String(row.action).toLowerCase()}` : "";
        return `
          <tr class="${isLatest ? 'timeline-latest ' + statusClass : ''}">
            <td>${mapStatusLabel(row.action)}</td>
            <td class="role">${roleLabel(row.actor_role)}</td>
            <td>${row.note ? escapeHtml(row.note) : '-'}</td>
            <td>${fmtDateTime(row.created_at)}</td>
          </tr>
        `;
      }).join("");

      showModal();
    }catch(e){
      showCenterAlert({ title:"‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", message:"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message });
    }
  }

  // ===== Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / ‡∏¢‡∏∑‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á =====
  const editModal   = document.getElementById("editModal");
  const editClose   = document.getElementById("editClose");
  const editCancel  = document.getElementById("editCancel");
  const editSaveBtn = document.getElementById("editSave");

  function showEditModal(){ editModal.classList.add("show"); }
  function hideEditModal(){
    editModal.classList.remove("show");
    editingRequest = null;
  }

  editClose.addEventListener("click", hideEditModal);
  editCancel.addEventListener("click", hideEditModal);
  editModal.addEventListener("click", e=>{ if(e.target === editModal) hideEditModal(); });

  function openEditModal(req){
    editingRequest = req || null;
    if(!editingRequest){
      showCenterAlert({ title:"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", message:"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠" });
      return;
    }
    document.getElementById("e-id").textContent = editingRequest.id || "-";
    document.getElementById("e-title").value    = editingRequest.title || "";
    document.getElementById("e-amount").value   = editingRequest.amount || "";
    document.getElementById("e-desc").value     = editingRequest.description || "";
    document.getElementById("e-note").value     = "‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß";

    showEditModal();
  }

  editSaveBtn.addEventListener("click", async () => {
    if(!editingRequest) {
      showCenterAlert({ title:"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", message:"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠" });
      return;
    }

    const newTitle  = document.getElementById("e-title").value.trim();
    const newAmount = Number(document.getElementById("e-amount").value);
    const newDesc   = document.getElementById("e-desc").value.trim();
    const note      = document.getElementById("e-note").value.trim() || "‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";

    if(!newTitle || !(newAmount > 0)){
      showCenterAlert({ title:"‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô", message:"‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" });
      return;
    }

    editSaveBtn.disabled = true;

    try{
      const res = await fetch(`${BASE}/api/requests/${encodeURIComponent(editingRequest.id)}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify({
          status: STATUS_PENDING,
          note,
          title:  newTitle,
          amount: newAmount,
          desc:   newDesc
        })
      });
      const data = await res.json().catch(()=>({}));
      if(!res.ok || !data.ok){
        throw new Error(data.error || "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      }

      hideEditModal();
      await loadMyRequests();
      showCenterAlert({ title:"‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", message:"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" });
    }catch(err){
      showCenterAlert({ title:"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", message:"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message });
    }finally{
      editSaveBtn.disabled = false;
    }
  });

  // ===== Finance =====
  async function loadFinanceSummary(){
    const el = document.getElementById("fin-balance");
    if(!el) return;
    el.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";

    try{
      const res = await fetch(`${BASE}/api/finance/summary`, {
        headers:{ Authorization:"Bearer "+token }
      });
      if(!res.ok) throw new Error("load-summary-failed");
      const data = await res.json().catch(()=>({}));
      const bal = data.total_balance ?? data.balance ?? 0;
      el.textContent = fmtBaht(bal) + " ‡∏ö‡∏≤‡∏ó";
    }catch(e){
      el.textContent = "- (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° API / ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)";
    }
  }

  async function loadFinanceAccounts(){
    const tb = document.getElementById("fin-accounts-body");
    if(!tb) return;
    tb.innerHTML = `<tr><td colspan="4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>`;

    try{
      const res = await fetch(`${BASE}/api/finance/accounts`, {
        headers:{ Authorization:"Bearer "+token }
      });
      if(!res.ok) throw new Error("load-accounts-failed");
      const data = await res.json().catch(()=>({}));
      const items = Array.isArray(data.items) ? data.items : [];
      currentAccounts = items;

      if(!items.length){
        tb.innerHTML = `<tr><td colspan="4">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ -</td></tr>`;
        return;
      }

      tb.innerHTML = items.map(acc => `
        <tr>
          <td>${acc.account_name || '-'}</td>
          <td>${acc.bank_name || '-'}</td>
          <td>${acc.account_number || '-'}</td>
          <td>${fmtBaht(acc.current_balance ?? 0)} ‡∏ö‡∏≤‡∏ó</td>
        </tr>
      `).join("");
    }catch(e){
      tb.innerHTML = `<tr><td colspan="4">‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à / ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° API</td></tr>`;
    }
  }

  async function loadFinanceTransfers(){
    const tb = document.getElementById("fin-transfers-body");
    if(!tb) return;
    tb.innerHTML = `<tr><td colspan="4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>`;

    try{
      const res = await fetch(`${BASE}/api/finance/transfers`, {
        headers:{ Authorization:"Bearer "+token }
      });
      if(!res.ok) throw new Error("load-transfers-failed");
      const data = await res.json().catch(()=>({}));
      const items = Array.isArray(data.items) ? data.items : [];

      if(!items.length){
        tb.innerHTML = `<tr><td colspan="4">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô -</td></tr>`;
        return;
      }

      tb.innerHTML = items.map(tr => `
        <tr>
          <td>${fmtDateTime(tr.created_at)}</td>
          <td>${fmtBaht(tr.amount || 0)} ‡∏ö‡∏≤‡∏ó</td>
          <td>${(tr.bank_name || '-') + ' / ' + (tr.account_number || '-')}</td>
          <td>${tr.note || '-'}</td>
        </tr>
      `).join("");
    }catch(e){
      tb.innerHTML = `<tr><td colspan="4">‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à / ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° API</td></tr>`;
    }
  }

  async function loadFinance(){
    await Promise.all([
      loadFinanceSummary(),
      loadFinanceAccounts(),
      loadFinanceTransfers()
    ]).catch(()=>{});
  }

  function wireFinanceForm(){
    const form = document.getElementById("fin-account-form");
    if(!form) return;

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();

      if (currentAccounts.length >= MAX_BANK_ACCOUNTS) {
        showCenterAlert({
          title: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏î‡πâ",
          message: `‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (${MAX_BANK_ACCOUNTS} ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ) ‡πÅ‡∏•‡πâ‡∏ß\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà`
        });
        return;
      }

      const accountName   = document.getElementById("fin-account-name").value.trim();
      const bankName      = document.getElementById("fin-bank-name").value.trim();
      const accountNumber = document.getElementById("fin-account-number").value.trim();

      if(!accountName || !bankName || !accountNumber){
        showCenterAlert({
          title: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô",
          message: "‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ, ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"
        });
        return;
      }

      const btn = document.getElementById("fin-add-account-btn");
      if(btn) btn.disabled = true;

      try{
        const res = await fetch(`${BASE}/api/finance/accounts`, {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            Authorization:"Bearer "+token
          },
          body:JSON.stringify({
            account_name:   accountName,
            bank_name:      bankName,
            account_number: accountNumber
          })
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok || data.ok === false){
          throw new Error(data.error || "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }

        document.getElementById("fin-account-name").value   = "";
        document.getElementById("fin-bank-name").value      = "";
        document.getElementById("fin-account-number").value = "";

        await loadFinanceAccounts();

        showCenterAlert({ title: "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", message: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" });
      }catch(err){
        showCenterAlert({ title: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", message: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: " + err.message });
      }finally{
        if(btn) btn.disabled = false;
      }
    });
  }

  // ===== CREDIT =====
  async function loadCredit(){
    const balEl = document.getElementById("credit-balance");
    const msgEl = document.getElementById("credit-message");
    if(!balEl) return;

    balEl.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
    if(msgEl) msgEl.textContent = "";

    try{
      const res = await fetch(`${BASE}/api/finance/credits`, {
        headers:{ Authorization:"Bearer "+token }
      });
      const data = await res.json().catch(()=>({}));
      if(!res.ok || !data.ok){
        throw new Error(data.error || "‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      }
      const bal = data.balance ?? 0;
      balEl.textContent = fmtBaht(bal);
    }catch(e){
      balEl.textContent = "-";
      if(msgEl){
        msgEl.style.color = "#b91c1c";
        msgEl.textContent = "‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message;
      }
    }
  }

  function wireCredit(){
    const btn    = document.getElementById("credit-topup-btn");
    const input  = document.getElementById("credit-topup-amount");
    const msgEl  = document.getElementById("credit-message");
    const balEl  = document.getElementById("credit-balance");
    if(!btn || !input || !msgEl || !balEl) return;

    btn.addEventListener("click", async ()=>{
      const amount = parseFloat(input.value || "0");
      msgEl.textContent = "";
      msgEl.style.color = "#6b7280";

      if(!(amount > 0)){
        msgEl.style.color = "#b91c1c";
        msgEl.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
        return;
      }

      btn.disabled = true;
      try{
        const res = await fetch(`${BASE}/api/finance/credits/topup`, {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            Authorization:"Bearer "+token
          },
          body: JSON.stringify({ amount })
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok || !data.ok){
          throw new Error(data.error || "‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }

        const bal = data.balance ?? 0;
        balEl.textContent = fmtBaht(bal);
        input.value = "";
        msgEl.style.color = "#0f766e";
        msgEl.textContent = "‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
      }catch(e){
        msgEl.style.color = "#b91c1c";
        msgEl.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message;
      }finally{
        btn.disabled = false;
      }
    });
  }

  // ===== Sidebar =====
  function initSidebar(){
    const layout   = document.getElementById("empLayout");
    const toggle   = document.getElementById("sidebarToggle");
    const navItems = document.querySelectorAll(".emp-nav-item");
    const views    = document.querySelectorAll(".emp-view");

    if(toggle && layout){
      toggle.addEventListener("click", () => {
        layout.classList.toggle("sidebar-open");
      });
    }

    navItems.forEach(btn => {
      btn.addEventListener("click", () => {
        const viewKey = btn.dataset.view;
        navItems.forEach(b => b.classList.remove("is-active"));
        btn.classList.add("is-active");

        views.forEach(sec => {
          sec.classList.toggle("is-active", sec.id === `view-${viewKey}`);
        });

        if(viewKey === "finance"){
          loadFinance();
        }else if(viewKey === "credit"){
          loadCredit();
        }else if(viewKey === "requests"){
          loadCreditSummaryForRequest();
        }

        layout.classList.remove("sidebar-open");
      });
    });
  }

  // ===== Boot =====
  (async function start(){
    try{
      const me = await verifyMe();
      if(me.role !== "employee") throw new Error("role-mismatch");
      localStorage.setItem("icr_session_v1", JSON.stringify(me));
      document.getElementById("who").textContent = `${me.name} (${me.username})`;

      bindLogout();
      initSidebar();
      wireInbox();               // ‚úÖ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢
      wireForm();
      initFormValidation();
      wireFinanceForm();
      wireCredit();

      await Promise.all([
        loadMyRequests(),
        loadCreditSummaryForRequest(),
        refreshInbox()           // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
      ]);
    }catch(e){
      localStorage.removeItem("jwt_token");
      localStorage.removeItem("icr_session_v1");
      location.href = "index.html";
    }
  })();
</script>
</body>
</html>
