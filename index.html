<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>เข้าสู่ระบบ – ICORP (v5)</title>
  <link rel="stylesheet" href="assets/css/login.css" />
  <style>.debug{margin-top:12px;font-size:12px;color:#0b7;white-space:pre-wrap}</style>
</head>
<body class="auth theme-orange">
  <main class="auth-shell">
    <section class="auth-frame">
      <aside class="auth-left">
        <div class="brand">
          <img src="assets/img/icorp-logo.jpg" alt="ICORP" class="brand-logo" />
          <div class="brand-name">Islamic Systems Corporation</div>
        </div>
        <h2 class="welcome">ระบบชำระเงินโรงเรียน</h2>
        <p class="desc">โอน–อนุมัติ–ติดตามสถานะแบบเรียลไทม์</p>
        <small class="footnote">© ICORP – School Smart Payment</small>
      </aside>
      <section class="auth-right" aria-label="เข้าสู่ระบบ">
        <h1 class="form-title">เข้าสู่ระบบ</h1>
        <form id="loginForm" class="login-form" action="javascript:void(0)" method="post" novalidate>
          <label for="username">ชื่อผู้ใช้</label>
          <div class="input"><input id="username" name="username" autocomplete="username" placeholder="ชื่อผู้ใช้งาน" required /></div>
          <label for="password">รหัสผ่าน</label>
          <div class="input"><input id="password" name="password" type="password" autocomplete="current-password" placeholder="••••••••" required /></div>
          <div id="err" class="err" role="alert" aria-live="assertive"></div>
          <button id="btnLogin" class="btn-primary" type="button"><span class="btn-label">เข้าสู่ระบบ</span><span class="spinner" aria-hidden="true"></span></button>
          <div class="debug" id="debug"></div>
        </form>
      </section>
    </section>
  </main>
  <script>
  window.BACKEND_URL = "http://localhost/school_api/public";
</script>
  <script>
  const BASE = window.BACKEND_URL || "http://localhost/school_api/public";

  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("btnLogin");
    const e   = document.getElementById("err");
    const u   = document.getElementById("username");
    const p   = document.getElementById("password");

    btn.addEventListener("click", async () => {
      e.textContent = "";
      const username = (u?.value || "").trim();
      const password = (p?.value || "");

      if (!username || !password) {
        e.textContent = "กรุณากรอกชื่อผู้ใช้และรหัสผ่าน";
        return;
      }

      btn.classList.add("loading");
      btn.setAttribute("disabled", "disabled");
      try {
        // login
        const res = await fetch(`${BASE}/api/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });
        if (!res.ok) {
          // ไม่แสดงรายละเอียด JSON ใด ๆ
          throw new Error("invalid");
        }
        const data = await res.json();

        // เก็บ token
        localStorage.setItem("jwt_token", data.token);

        // ดึงโปรไฟล์
        const meRes = await fetch(`${BASE}/api/auth/me?token=${encodeURIComponent(data.token)}`, {
          headers: { Authorization: "Bearer " + data.token }
        });
        if (!meRes.ok) throw new Error("verify-failed");
        const meData = await meRes.json();

        const me = meData.profile;
        localStorage.setItem("icr_session_v1", JSON.stringify(me));

        // ส่งตาม role
        if (me.role === "employee")        location.href = "employee.html";
        else if (me.role === "director")   location.href = "director.html";
        else if (me.role === "icorp-staff")   location.href = "icorp-staff.html";
        else if (me.role === "icorp-manager") location.href = "icorp-manager.html";
        else {
          e.textContent = "บทบาทไม่ถูกต้อง";
          localStorage.removeItem("jwt_token");
          localStorage.removeItem("icr_session_v1");
        }
      } catch (err) {
        // แสดงเฉพาะข้อความสั้น ๆ
        e.textContent = "ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง";
        localStorage.removeItem("jwt_token");
        localStorage.removeItem("icr_session_v1");
      } finally {
        btn.classList.remove("loading");
        btn.removeAttribute("disabled");
      }
    });
  });
</script>

</body>
</html>
