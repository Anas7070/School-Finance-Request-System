<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‚Äì ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠</title>

  <link rel="stylesheet" href="assets/css/base.css">
  <link rel="stylesheet" href="assets/css/director.css">

  <script>
    window.BACKEND_URL = "http://localhost/school_api/public";
  </script>
</head>
<body>
<header>
  <div class="wrap row" style="justify-content:space-between">
    <div>
      <h1>‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
      <div class="subtitle">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≤‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‚Üí ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ ICORP Staff</div>
    </div>
    <div class="nav" id="navUser">
      <span class="status" id="who"></span>
      <a class="btn" href="#" id="logout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
    </div>
  </div>
</header>

<main class="wrap dir-layout" id="dirLayout">
  <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π -->
  <button class="sidebar-toggle" id="sidebarToggle">‚ò∞ ‡πÄ‡∏°‡∏ô‡∏π</button>

  <!-- Sidebar -->
  <aside class="dir-sidebar" id="dirSidebar">
    <div class="dir-sidebar-header">
      <div class="dir-sidebar-title">‡πÄ‡∏°‡∏ô‡∏π‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£</div>
      <div class="dir-sidebar-sub">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö / ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠</div>
    </div>

    <nav class="dir-nav">
      <button class="dir-nav-item is-active" data-view="pending">üìÑ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
    </nav>
  </aside>

  <!-- Main -->
  <section class="dir-main">
    <section id="view-pending" class="dir-view is-active">
      <div class="card">
        <h3>‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h3>
        <table id="dirTable" class="request-table" style="margin-top:8px">
          <thead>
            <tr>
              <th>‡∏£‡∏´‡∏±‡∏™</th>
              <th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
              <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
              <th>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
              <th>ACTION</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </section>
</main>

<!-- Modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î -->
<div id="detailModal" class="modal-backdrop">
  <div class="modal-box">
    <div class="modal-header">
      <h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠</h3>
      <button class="modal-close" id="detailClose">&times;</button>
    </div>
    <div class="modal-body">
      <div class="detail-section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠</div>
      <div class="detail-grid">
        <div class="detail-label">‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≥‡∏Ç‡∏≠</div>
        <div class="detail-value" id="d-id">-</div>

        <div class="detail-label">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
        <div class="detail-value" id="d-school">-</div>

        <div class="detail-label">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</div>
        <div class="detail-value" id="d-title">-</div>

        <div class="detail-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>
        <div class="detail-value" id="d-amount">-</div>

        <div class="detail-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
        <div class="detail-value">
          <span class="tag-status" id="d-status">-</span>
        </div>

        <div class="detail-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
        <div class="detail-value" id="d-desc">-</div>
      </div>

      <div class="detail-section-title">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Timeline)</div>
      <table class="timeline-table">
        <thead>
          <tr>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th>
            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
            <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
          </tr>
        </thead>
        <tbody id="d-timeline-body"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ -->
<div id="rejectModal" class="reject-modal">
  <div class="reject-modal-box">
    <div class="reject-modal-header">
      <h3>‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>
      <button class="reject-modal-close" id="rejectModalClose">&times;</button>
    </div>
    <div class="reject-modal-content">
      <div class="reject-modal-info">
        <p><strong>‡∏Ñ‡∏≥‡∏Ç‡∏≠:</strong> <span id="rejectRequestTitle">-</span></p>
        <p><strong>‡∏£‡∏´‡∏±‡∏™:</strong> <span id="rejectRequestId" class="mono">-</span></p>
        <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</strong> <span id="rejectRequestAmount">-</span></p>
      </div>

      <label class="reject-modal-label">
        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):
      </label>
      <textarea
        id="rejectNote"
        class="reject-modal-textarea"
        placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ..."
      ></textarea>
    </div>
    <div class="reject-modal-actions">
      <button class="reject-modal-btn reject-modal-cancel" id="rejectCancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="reject-modal-btn reject-modal-submit" id="rejectSubmit">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
    </div>
  </div>
</div>

<script src="assets/js/common.js"></script>
<script>
  const BASE  = window.BACKEND_URL || "http://localhost/school_api/public";
  const token = localStorage.getItem("jwt_token");
  if (!token) location.href = "index.html";

  const STATUS_PENDING  = "Pending";
  const STATUS_VERIFIED = "Verified";
  const STATUS_REVIEWED = "Reviewed";
  const STATUS_APPROVED = "Approved";
  const STATUS_REJECTED = "Rejected";

  function roleLabel(role){
    switch(role){
      case 'employee':      return '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
      case 'director':      return '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£';
      case 'icorp-staff':   return '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ICORP';
      case 'icorp-manager': return '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ ICORP';
      default:              return role || '-';
    }
  }

  function mapStatusLabel(s){ return s || "-"; }

  function mapStatusClass(s){
    switch(s){
      case STATUS_PENDING:  return "status-pending";
      case STATUS_VERIFIED: return "status-reviewed";
      case STATUS_REVIEWED: return "status-reviewed";
      case STATUS_APPROVED: return "status-approved";
      case STATUS_REJECTED: return "status-rejected";
      default:              return "";
    }
  }

  function fmtBaht(n){
    try { return Number(n).toLocaleString('th-TH', {minimumFractionDigits: 0}); }
    catch { return n; }
  }
  function fmtDateTime(str){
    if(!str) return '-';
    try{ return new Date(str).toLocaleString('th-TH'); }catch(e){ return str; }
  }

  async function verifyMe() {
    const url = `${BASE}/api/auth/me?token=${encodeURIComponent(token)}`;
    const res = await fetch(url, { headers: { Authorization: "Bearer " + token }});
    const data = await res.json().catch(()=> ({}));
    if (!res.ok || !data.profile) throw new Error("verify-failed");
    return data.profile;
  }

  async function initAuth() {
    try {
      const me = await verifyMe();
      if (me.role !== "director") throw new Error("role-mismatch");
      localStorage.setItem("icr_session_v1", JSON.stringify(me));
      document.getElementById("who").textContent = `${me.name} (${me.username})`;

      const lg = document.getElementById("logout");
      if (lg) lg.addEventListener("click", (e) => {
        e.preventDefault();
        localStorage.removeItem("jwt_token");
        localStorage.removeItem("icr_session_v1");
        location.href = "index.html";
      });
    } catch (e) {
      localStorage.removeItem("jwt_token");
      localStorage.removeItem("icr_session_v1");
      location.href = "index.html";
    }
  }

  // ===== Sidebar =====
  function initSidebar(){
    const layout = document.getElementById("dirLayout");
    const toggle = document.getElementById("sidebarToggle");
    if(toggle && layout){
      toggle.addEventListener("click", ()=> layout.classList.toggle("sidebar-open"));
    }

    // ‡∏°‡∏µ view ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‡πÅ‡∏ï‡πà‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢
    document.querySelectorAll(".dir-nav-item").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".dir-nav-item").forEach(b=>b.classList.remove("is-active"));
        btn.classList.add("is-active");
        layout.classList.remove("sidebar-open");
      });
    });
  }

  let currentRejectRequest = null;

  async function loadPending() {
    const r = await fetch(`${BASE}/api/requests`, {
      headers: { Authorization: "Bearer " + token }
    });
    if (r.status === 401) {
      localStorage.removeItem("jwt_token");
      localStorage.removeItem("icr_session_v1");
      location.href = "index.html";
      return;
    }
    const j = await r.json().catch(()=>({}));

    // director ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Pending
    const items = (j.items || []).filter(x => x.status === STATUS_PENDING);

    const tb = document.querySelector("#dirTable tbody");
    tb.innerHTML = items.map(row => `
      <tr>
        <td class="mono">${row.id}</td>
        <td>${row.title ?? "-"}</td>
        <td>${fmtBaht(Number(row.amount || 0))}</td>
        <td>${row.school ?? "-"}</td>
        <td>
          <span class="status ${mapStatusClass(row.status)}">
            ${mapStatusLabel(row.status)}
          </span>
        </td>
        <td>
          <button class="btn-link" data-detail-id="${row.id}">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
        </td>
        <td class="actions-cell">
          <button class="ok" data-act="verify" data-id="${row.id}">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
          <button class="danger" data-act="reject" data-id="${row.id}"
            data-title="${(row.title || '').replaceAll('"','&quot;')}"
            data-amount="${row.amount || 0}">
            ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
          </button>
        </td>
      </tr>
    `).join("");

    tb.querySelectorAll("button[data-detail-id]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-detail-id");
        openDetailModal(id);
      });
    });

    tb.querySelectorAll("button[data-act='verify']").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id  = btn.getAttribute("data-id");
        await doAction(id, STATUS_VERIFIED, "");
      });
    });

    tb.querySelectorAll("button[data-act='reject']").forEach(btn => {
      btn.addEventListener("click", () => {
        const id  = btn.getAttribute("data-id");
        const title = btn.getAttribute("data-title");
        const amount = btn.getAttribute("data-amount");

        currentRejectRequest = { id, title, amount };

        document.getElementById("rejectRequestId").textContent = id;
        document.getElementById("rejectRequestTitle").textContent = title || "-";
        document.getElementById("rejectRequestAmount").textContent =
          amount ? fmtBaht(amount) + " ‡∏ö‡∏≤‡∏ó" : "-";
        document.getElementById("rejectNote").value = "";

        showRejectModal();
      });
    });
  }

  async function doAction(id, newStatus, note) {
    try {
      const res = await fetch(`${BASE}/api/requests/${encodeURIComponent(id)}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify({ status: newStatus, note })
      });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok) throw new Error(data.error || "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

      await loadPending();
    } catch (e) {
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
    }
  }

  // ===== Modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î =====
  const modal = document.getElementById("detailModal");
  const closeBtn = document.getElementById("detailClose");
  function showModal(){ modal.classList.add("show"); }
  function hideModal(){ modal.classList.remove("show"); }
  closeBtn.addEventListener("click", hideModal);
  modal.addEventListener("click", (e)=>{ if(e.target === modal) hideModal(); });

  // ===== Modal ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ =====
  const rejectModal = document.getElementById("rejectModal");
  const rejectClose = document.getElementById("rejectModalClose");
  const rejectCancel = document.getElementById("rejectCancel");
  const rejectSubmit = document.getElementById("rejectSubmit");
  const rejectNote = document.getElementById("rejectNote");

  function showRejectModal() {
    rejectModal.classList.add("show");
    rejectNote.focus();
  }
  function hideRejectModal() {
    rejectModal.classList.remove("show");
    currentRejectRequest = null;
  }
  rejectClose.addEventListener("click", hideRejectModal);
  rejectCancel.addEventListener("click", hideRejectModal);

  rejectSubmit.addEventListener("click", async () => {
    if (!currentRejectRequest) return;
    const note = rejectNote.value.trim();
    await doAction(currentRejectRequest.id, STATUS_REJECTED, note);
    hideRejectModal();
  });

  rejectModal.addEventListener("click", (e) => {
    if (e.target === rejectModal) hideRejectModal();
  });

  rejectNote.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && e.ctrlKey) {
      e.preventDefault();
      rejectSubmit.click();
    }
  });

  async function openDetailModal(id){
    try{
      const res = await fetch(`${BASE}/api/requests/${encodeURIComponent(id)}/timeline`, {
        headers: { Authorization: "Bearer " + token }
      });
      const data = await res.json().catch(()=> ({}));
      if(!res.ok) throw new Error(data.error || "‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

      const r  = data.request || {};
      const tl = Array.isArray(data.timeline) ? data.timeline : [];

      document.getElementById("d-id").textContent     = r.id || "-";
      document.getElementById("d-school").textContent = r.school || "-";
      document.getElementById("d-title").textContent  = r.title || "-";
      document.getElementById("d-amount").textContent = r.amount ? fmtBaht(r.amount)+" ‡∏ö‡∏≤‡∏ó" : "-";
      document.getElementById("d-status").textContent = mapStatusLabel(r.status);
      document.getElementById("d-desc").textContent   = r.description || "-";

      const tb = document.getElementById("d-timeline-body");

      // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î
      const sortedTimeline = [...tl].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

      // ‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ‚Äú‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‚Äù ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏ó‡∏≥‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏ó‡∏ô
      tb.innerHTML = sortedTimeline.map((row, idx) => {
        const isLatest = idx === 0;

        const statusClass = row.action
          ? `status-${String(row.action).toLowerCase()}`
          : "";

        return `
          <tr class="${isLatest ? 'timeline-latest ' + statusClass : ''}">
            <td>${mapStatusLabel(row.action || '-')}</td>
            <td class="tl-one-line">${roleLabel(row.actor_role)}</td>
            <td class="tl-one-line">${row.note ? row.note : '-'}</td>
            <td>${fmtDateTime(row.created_at)}</td>
          </tr>
        `;
      }).join("");

      showModal();
    }catch(e){
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
    }
  }

  (async function start(){
    await initAuth();
    initSidebar();
    await loadPending();
  })();
</script>
</body>
</html>
