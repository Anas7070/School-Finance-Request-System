<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>เข้าสู่ระบบ – ICORP (v5)</title>
  <link rel="stylesheet" href="assets/css/login.css" />
</head>
<body class="auth theme-orange">
  <main class="auth-shell">
    <section class="auth-frame">
      <aside class="auth-left">
        <div class="brand">
          <img src="assets/img/icorp-logo.jpg" alt="ICORP" class="brand-logo" />
          <div class="brand-name">Islamic Systems Corporation</div>
        </div>
        <h2 class="welcome">ระบบชำระเงินโรงเรียน</h2>
        <p class="desc">โอน–อนุมัติ–ติดตามสถานะแบบเรียลไทม์</p>

        <div class="illustration" aria-hidden="true">
          <div class="wallet"></div>
          <div class="coin c1"></div>
          <div class="coin c2"></div>
          <div class="school"></div>
        </div>

        <small class="footnote">© ICORP – School Smart Payment</small>
      </aside>

      <section class="auth-right" aria-label="เข้าสู่ระบบ">
        <h1 class="form-title">เข้าสู่ระบบ</h1>

        <!-- ใช้ form แค่เพื่อโครงสร้าง แต่ "ไม่" submit -->
        <form id="loginForm" class="login-form" action="javascript:void(0)" method="post" novalidate>
          <label for="username">ชื่อผู้ใช้</label>
          <div class="input">
            <input id="username" name="username" autocomplete="username" placeholder="ชื่อผู้ใช้งาน" required />
          </div>

          <label for="password">รหัสผ่าน</label>
          <div class="input">
            <input id="password" name="password" type="password" autocomplete="current-password" placeholder="••••••••" required />
          </div>

          <div id="err" class="err" role="alert" aria-live="assertive"></div>

          <!-- เปลี่ยนเป็นปุ่มธรรมดา ไม่ใช่ type="submit" -->
          <button id="btnLogin" class="btn-primary" type="button">
            <span class="btn-label">เข้าสู่ระบบ</span>
            <span class="spinner" aria-hidden="true"></span>
          </button>
        </form>
      </section>
    </section>
  </main>

  <script src="assets/js/common.js"></script>
  <script>
    // ปรับตามพอร์ต/โดเมนของ backend
    window.BACKEND_URL = "http://localhost:4000";
  </script>

  <!-- สคริปต์ทำงานแบบ self-contained -->
  <script>
    const BASE = window.BACKEND_URL || "http://localhost:4000";
    const ROLE_TO_PAGE = {
      "school-emp": "employee.html",
      "school-dir": "director.html",
      "icorp-staff": "icorp-staff.html",
      "icorp-mgr":  "icorp-manager.html",
    };

    async function apiLogin(username, password) {
      const res = await fetch(BASE + "/api/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          username: String(username || "").trim(),
          password: String(password || "")
        })
      });
      if (!res.ok) {
        const t = await res.text().catch(() => "");
        throw new Error(t || "Login failed");
      }
      return res.json(); // { token }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const u   = document.getElementById("username");
      const p   = document.getElementById("password");
      const e   = document.getElementById("err");
      const btn = document.getElementById("btnLogin");

      if (u) u.focus();

      // ป้องกัน enter ในช่อง input ที่ทำให้ browser submit เอง
      document.getElementById("loginForm").addEventListener("keydown", (ev) => {
        if (ev.key === "Enter") ev.preventDefault();
      });

      btn.addEventListener("click", async () => {
        const username = (u?.value || "").trim();
        const password = (p?.value || "");

        e.textContent = "";
        if (!username || !password) {
          e.textContent = "กรุณากรอกชื่อผู้ใช้และรหัสผ่าน";
          return;
        }

        btn.classList.add("loading");
        btn.setAttribute("disabled", "disabled");

        try {
          // 1) login -> token
          const { token } = await apiLogin(username, password);
          localStorage.setItem("jwt_token", token);

          // 2) /me -> profile + role
          const meRes = await fetch(BASE + "/api/auth/me", {
            headers: { Authorization: "Bearer " + token }
          });
          if (!meRes.ok) throw new Error("verify failed");
          const me = await meRes.json();

          // 3) เก็บ session
          localStorage.setItem("icr_session_v1", JSON.stringify({
            id: me.id, username: me.username, name: me.name, role: me.role
          }));

          // 4) ไปหน้าตาม role
          const next = ROLE_TO_PAGE[me.role] || "employee.html";
          window.location.href = next;

        } catch (err) {
          console.error(err);
          e.textContent = "เข้าสู่ระบบไม่สำเร็จ";
          localStorage.removeItem("jwt_token");
          localStorage.removeItem("icr_session_v1");
        } finally {
          btn.classList.remove("loading");
          btn.removeAttribute("disabled");
        }
      });
    });
  </script>
</body>
</html>
